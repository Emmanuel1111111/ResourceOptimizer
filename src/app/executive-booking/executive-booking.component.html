<div class="modern-container">
  <!-- Database Connection Error Alert -->
  <div *ngIf="dbConnectionError" class="database-error-alert">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-content">
      <h3>Database Connection Error</h3>
      <p>{{dbErrorMessage}}</p>
      <div class="error-actions">
        <button class="action-button secondary" (click)="retryDatabaseConnection()">
          <span class="button-icon">‚Üª</span> Retry Connection
        </button>
        <button class="action-button primary" (click)="showTroubleshootingGuide = !showTroubleshootingGuide">
          <span class="button-icon">üîß</span> {{showTroubleshootingGuide ? 'Hide' : 'Show'}} Troubleshooting Guide
        </button>
      </div>
      
      <!-- Troubleshooting Guide -->
      <div *ngIf="showTroubleshootingGuide" class="troubleshooting-guide">
        <h4>MongoDB Connection Troubleshooting Guide</h4>
        <ol>
          <li><strong>Check MongoDB URI:</strong> Verify that the MONGO_URI environment variable is correctly set in your .env file.</li>
          <li><strong>Network Issues:</strong> Ensure your network allows connections to MongoDB Atlas or your local MongoDB server.</li>
          <li><strong>Local MongoDB:</strong> If using a local MongoDB, make sure the MongoDB service is running:
            <pre>brew services start mongodb-community</pre>
            or
            <pre>sudo systemctl start mongod</pre>
          </li>
          <li><strong>Firewall Settings:</strong> Check if your firewall is blocking MongoDB connections (default port: 27017).</li>
          <li><strong>DNS Resolution:</strong> The error "no nameservers" indicates a DNS resolution issue. Try using a direct connection string instead of SRV format.</li>
          <li><strong>MongoDB Atlas:</strong> Verify that your IP address is whitelisted in MongoDB Atlas Network Access settings.</li>
          <li><strong>Credentials:</strong> Ensure your username and password are correct in the connection string.</li>
        </ol>
        
        <h4>MongoDB URI Format</h4>
        <p>Make sure your MongoDB URI follows the correct format:</p>
        <div class="code-block">
          <p><strong>MongoDB Atlas (SRV):</strong></p>
          <pre>mongodb+srv://&lt;username&gt;:&lt;password&gt;&#64;&lt;cluster&gt;.mongodb.net/&lt;database&gt;?retryWrites=true&amp;w=majority</pre>
          
          <p><strong>MongoDB Atlas (Direct):</strong></p>
          <pre>mongodb://&lt;username&gt;:&lt;password&gt;&#64;&lt;host1&gt;:&lt;port1&gt;,&lt;host2&gt;:&lt;port2&gt;/&lt;database&gt;?replicaSet=&lt;replicaSetName&gt;</pre>
          
          <p><strong>Local MongoDB:</strong></p>
          <pre>mongodb://localhost:27017/&lt;database&gt;</pre>
        </div>
        
        <p><strong>Note:</strong> After fixing the issue, restart both the backend and frontend applications.</p>
      </div>
    </div>
    <button class="close-button" (click)="dbConnectionError = false">√ó</button>
  </div>

  <div class="header-section">
    <h1 class="title animated-text">
      <span class="resource-text">Resource</span> 
      <span class="optimization-text">Optimization</span>
    </h1>
    <p class="subtitle">Executive Management Console</p>
  </div>

  <div class="content-card">
    <div class="tab-navigation">
      <div class="tab-wrapper">
        <button 
          *ngFor="let tab of tabs; let i = index;" 
          [class.active]="activeTab.includes(tab)"
          (click)="onTabChange(i)"
          class="tab-button">
          {{tab}}
        </button> 
      </div>
    </div>
 
        <!-- Check Overlap Tab -->
    <div *ngIf="activeTab === 'Check Overlap'" class="tab-content">
      <div class="tab-pane fade-in">
        
        <!-- Operation Mode Info -->
        <div class="operation-modes-info">
          <h4>üìä Check Overlap Operation Modes</h4>
          <div class="mode-cards">
            <div class="mode-card" [class.active]="!form.get('startTime')?.value || !form.get('endTime')?.value">
              <div class="mode-icon">üîç</div>
              <h5>Comprehensive Room Analysis</h5>
              <p>Leave times empty to analyze ALL schedules for the room and day</p>
              <ul>
                <li>‚Ä¢ Detect all schedule conflicts</li>
                <li>‚Ä¢ Show room utilization</li>
                <li>‚Ä¢ Find available time slots</li>
                <li>‚Ä¢ Get optimization recommendations</li>
              </ul>
            </div>
            <div class="mode-card" [class.active]="form.get('startTime')?.value && form.get('endTime')?.value">
              <div class="mode-icon">üéØ</div>
              <h5>Specific Time Slot Check</h5>
              <p>Enter times to check if a specific slot conflicts</p>
              <ul>
                <li>‚Ä¢ Check availability for specific time</li>
                <li>‚Ä¢ See conflicting schedules</li>
                <li>‚Ä¢ Plus full room analysis</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <form [formGroup]="form" class="modern-form">
            <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Room ID</label>
                <input class="form-input" formControlName="roomId" placeholder="Enter room ID" required>
                <div *ngIf="form.get('roomId')?.hasError('required') && form.get('roomId')?.touched" class="error-message">
                  Room ID is required
                </div>
              </div>
              
              <div class="form-group highlighted-field animate-on-hover">
                <label class="form-label">Day</label>
                <select class="form-select" formControlName="day" required>
                  <option value="" disabled selected>Select day</option>
                  <option *ngFor="let day of dayOptions" [value]="day">{{day}}</option>
                </select>
                <div *ngIf="form.get('day')?.hasError('required') && form.get('day')?.touched" class="error-message">
                  Day is required
                </div>
                <div class="form-hint">Day-based scheduling is prioritized</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Date (Optional)</label>
                <input class="form-input" type="date" formControlName="date">
                <div class="form-hint">Only used if day-based scheduling fails</div>
              </div>
            </div>

            <div class="form-row time-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Start Time (Optional)</label>
                <select class="form-select" formControlName="startTime">
                  <option value="" disabled selected>Select time (for specific slot check)</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
                <div class="form-hint">Leave empty for comprehensive room analysis</div>
              </div>
              
              <div class="form-group animate-on-hover">
                <label class="form-label">End Time (Optional)</label>
                <select class="form-select" formControlName="endTime">
                  <option value="" disabled selected>Select time (for specific slot check)</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
                <div class="form-hint">Leave empty for comprehensive room analysis</div>
              </div>
            </div>
            
            <div class="form-actions">
              <button 
                class="action-button primary pulse-animation" 
                (click)="executeOperation('check_overlap')" 
                [disabled]="loading || !form.get('roomId')?.valid || !form.get('day')?.valid">
                <span class="button-icon">üîç</span> 
                {{ form.get('startTime')?.value && form.get('endTime')?.value ? 'Check Specific Time Slot' : 'Analyze Room Schedule' }}
              </button>
            </div>
          </form>
        </div>

        <!-- Results Section for Check Overlap -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Processing request...</p>
        </div>

      </div>
    </div>
        
        <!-- Suggest Rooms Tab -->
    <div *ngIf="activeTab === 'Suggest Rooms'" class="tab-content">
      <div class="tab-pane fade-in">
        <div class="form-section">
          <form [formGroup]="form" class="modern-form">
            <div class="form-row">
              <div class="form-group highlighted-field animate-on-hover">
                <label class="form-label">Day</label>
                <select class="form-select" formControlName="day" required>
                  <option value="" disabled selected>Select day</option>
                  <option *ngFor="let day of dayOptions" [value]="day">{{day}}</option>
                </select>
                <div *ngIf="form.get('day')?.hasError('required') && form.get('day')?.touched" class="error-message">
                  Day is required
                </div>
              </div>
            </div>

            <div class="form-row time-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Start Time</label>
                <select class="form-select" formControlName="startTime" required>
                  <option value="" disabled selected>Select time</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
              </div>
              
              <div class="form-group animate-on-hover">
                <label class="form-label">End Time</label>
                <select class="form-select" formControlName="endTime" required>
                  <option value="" disabled selected>Select time</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
              </div>
            </div>
            
           

            <div class="form-actions">
              <button class="action-button primary pulse-animation" (click)="executeOperation('suggest_rooms')" [disabled]="loading">
                <span class="button-icon">üè¢</span> Suggest Rooms
              </button>

              <!-- Debug button (remove in production) -->
              <button class="action-button secondary" (click)="debugRoomDisplay()" type="button" style="margin-left: 10px;">
                üîç Debug Room Display
              </button>
            </div>
          </form>
        </div>

        <!-- Results Section for Suggest Rooms -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Finding available rooms...</p>
        </div>

        <div *ngIf="results && !loading" class="results-section fade-in">
          <div class="results-header">
            <h2>Room Suggestions</h2>
          </div>

          <div class="results-summary">
            <div class="summary-card no-conflict">
              <div class="summary-icon">
                <span>üè¢</span>
              </div>
              <div class="summary-details">
                <h3>Available Rooms Found</h3>
                <p>Day: <strong>{{results.day}}</strong></p>
                <p>Time: <strong>{{results.time}}</strong></p>
                <p>Total rooms: <strong>{{results.total_rooms || 0}}</strong></p>
              </div>
            </div>
          </div>

          <!-- Empty Results Message -->
          <div *ngIf="results && (!results.suggested_rooms || results.suggested_rooms.length === 0)" class="empty-results">
            <div class="empty-icon">üè¢</div>
            <h3>No Available Rooms Found</h3>
            <p *ngIf="results.status === 'warning'">{{results.message}}</p>
            <p *ngIf="results.total_conflicted > 0">
              However, {{results.total_conflicted}} room(s) have conflicts during this time.
              <button class="view-conflicts-btn" (click)="showConflictedRooms = !showConflictedRooms">
                {{showConflictedRooms ? 'Hide' : 'View'}} Conflicted Rooms
              </button>
            </p>
            <div class="suggestions-tips">
              <h4>Try these suggestions:</h4>
              <ul>
                <li>Choose a different time slot</li>
                <li>Select a different day</li>
                <li>Check business hours: {{results.business_hours?.start}} - {{results.business_hours?.end}}</li>
              </ul>
            </div>
          </div>

          <div *ngIf="results.suggested_rooms && results.suggested_rooms.length > 0" class="suggestions-container">
            <h3>Suggested Rooms</h3>
            
            <!-- Room filtering options -->
            <div class="filter-options">
              <div class="search-box">
                <input 
                  type="text" 
                  placeholder="Search room ID..." 
                  [(ngModel)]="roomSearchQuery"
                  (input)="filterRooms()"
                  class="search-input"
                >
                <span class="search-icon">üîç</span>
              </div>
              
              <div class="sort-options">
                <label>Sort by: </label>
                <select [(ngModel)]="roomSortOption" (change)="sortRooms()">
                  <option value="room_id">Room ID</option>
                  <option value="free_slots">Available Time</option>
                  <option value="department">Department</option>
                </select>
              </div>
            </div>
            
      
            <!-- Display rooms with pagination -->
            <div class="suggestions-grid">
              <div *ngFor="let room of displayedRooms; let i = index; trackBy: trackByRoomId" class="suggestion-card animate-in" [style.animation-delay]="i * 0.1 + 's'">
                <div class="suggestion-header">
                  <span class="suggestion-room">{{room.room_id}}</span>
                  <span class="room-status" [class]="room.status?.toLowerCase()">{{room.status}}</span>
                </div>

                <!-- Enhanced Room Information -->
                <div class="room-info" *ngIf="room.department || room.utilization_percentage">
                
                  <div class="info-item" *ngIf="room.utilization_percentage !== undefined">
                    <span class="info-label">Utilization:</span>
                    <span class="info-value">{{room.utilization_percentage}}%</span>
                  </div>
                  <div class="info-item" *ngIf="room.total_schedules">
                    <span class="info-label">Schedules:</span>
                    <span class="info-value">{{room.total_schedules}}</span>
                  </div>
                </div>

                <div class="free-slots-container" *ngIf="room.free_slots && room.free_slots.length > 0">
                  <h4>Free Time Slots ({{room.free_slots.length}})</h4>
                  <div class="free-slots-list">
                    <div *ngFor="let slot of room.free_slots" class="free-slot-item">
                      <div class="time-range">
                        <span class="time-start">{{slot.start}}</span>
                        <span class="time-separator">‚Üí</span>
                        <span class="time-end">{{slot.end}}</span>
                      </div>
                      <span class="duration-badge">{{slot.duration}}</span>
                    </div>
                  </div>
                </div>

                <!-- No Free Slots Message -->
                <div class="no-slots-message" *ngIf="!room.free_slots || room.free_slots.length === 0">
                  <p>No free time slots available</p>
                </div>
                
                <div class="suggestion-details">
                  <div class="requested-slot" *ngIf="room.requested_slot">
                    <p><span class="detail-label">Requested Time:</span> {{room.requested_slot.start}} - {{room.requested_slot.end}}</p>
                    <p><span class="detail-label">Duration:</span> {{room.requested_slot.duration}}</p>
                  </div>
                </div>
                
                <div class="card-footer">
                  <button class="action-button secondary" (click)="selectRoom(room)">
                    Select Room
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-controls" *ngIf="results.suggested_rooms.length > 8">
              <div class="pagination-info">
                Showing {{displayedRooms.length}} of {{filteredRooms.length}} rooms
              </div>
              <div class="pagination-buttons">
                <button 
                  *ngIf="currentPage > 1" 
                  class="pagination-button" 
                  (click)="changePage(currentPage - 1)">
                  Previous
                </button>
                
                <div class="page-indicators">
                  <span *ngFor="let page of getPageNumbers()" 
                    [class.active]="page === currentPage"
                    (click)="changePage(page)"
                    class="page-number">
                    {{page}}
                  </span>
                </div>
                
                <button 
                  *ngIf="currentPage < totalPages" 
                  class="pagination-button" 
                  (click)="changePage(currentPage + 1)">
                  Next
                </button>
                
                <button 
                  *ngIf="displayedRooms.length < filteredRooms.length && currentPage === totalPages" 
                  class="pagination-button show-more" 
                  (click)="showAllRooms()">
                  Show All ({{filteredRooms.length - displayedRooms.length}} more)
            </button>
              </div>
            </div>
          </div>

          <!-- Conflicted Rooms Section -->
          <div *ngIf="results.conflicted_rooms && results.conflicted_rooms.length > 0 && (showConflictedRooms || results.suggested_rooms?.length === 0)" class="conflicted-rooms-container">
            <h3>Conflicted Rooms ({{results.conflicted_rooms.length}})</h3>
            <p class="conflict-explanation">These rooms have scheduling conflicts during your requested time:</p>

            <div class="conflicted-rooms-grid">
              <div *ngFor="let room of results.conflicted_rooms" class="conflicted-room-card">
                <div class="room-header">
                  <span class="room-id">{{room.room_id}}</span>
                  <span class="conflict-badge">Conflict</span>
                </div>

                <div class="conflict-details" *ngIf="room.conflict">
                  <div class="conflict-info">
                    <span class="conflict-label">Conflicting Course:</span>
                    <span class="conflict-value">{{room.conflict.course}}</span>
                  </div>
                  <div class="conflict-info">
                    <span class="conflict-label">Time:</span>
                    <span class="conflict-value">{{room.conflict.time}}</span>
                  </div>
                  <div class="conflict-info" *ngIf="room.conflict.department">
                    <span class="conflict-label">Department:</span>
                    <span class="conflict-value">{{room.conflict.department}}</span>
                  </div>
                </div>

                <!-- Show available slots for conflicted rooms -->
                <div class="alternative-slots" *ngIf="room.free_slots && room.free_slots.length > 0">
                  <h5>Alternative Time Slots:</h5>
                  <div class="alt-slots-list">
                    <div *ngFor="let slot of room.free_slots.slice(0, 3)" class="alt-slot">
                      {{slot.start}} - {{slot.end}} ({{slot.duration}})
                    </div>
                    <div *ngIf="room.free_slots.length > 3" class="more-slots">
                      +{{room.free_slots.length - 3}} more slots
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        
        <!-- Inject Schedule Tab -->
    <div *ngIf="activeTab === 'Inject Schedule'" class="tab-content">
      <div class="tab-pane fade-in">
        <div class="form-section">
          <form [formGroup]="form" class="modern-form">
            <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Room ID</label>
                <input class="form-input" formControlName="roomId" placeholder="Enter room ID" required>
              </div>
              
              <div class="form-group highlighted-field animate-on-hover">
                <label class="form-label">Day</label>
                <select class="form-select" formControlName="day" required>
                  <option value="" disabled selected>Select day</option>
                  <option *ngFor="let day of dayOptions" [value]="day">{{day}}</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Date</label>
                <input class="form-input" type="date" formControlName="date">
              </div>
            </div>

            <div class="form-row time-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Start Time</label>
                <select class="form-select" formControlName="startTime" required>
                  <option value="" disabled selected>Select time</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
              </div>
              
              <div class="form-group animate-on-hover">
                <label class="form-label">End Time</label>
                <select class="form-select" formControlName="endTime" required>
                  <option value="" disabled selected>Select time</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Course</label>
                <input class="form-input" formControlName="course" placeholder="Enter course name">
              </div>
              
              <div class="form-group animate-on-hover">
                <label class="form-label">Department</label>
                <input class="form-input" formControlName="department" placeholder="Enter department">
              </div>
              
              <div class="form-group animate-on-hover">
                <label class="form-label">Year</label>
                <input class="form-input" formControlName="level" placeholder="Enter year">
              </div>
            </div>

            <div class="form-actions">
              <button class="action-button primary pulse-animation" (click)="executeOperation('inject_schedule')" [disabled]="loading">
                <span class="button-icon">‚ûï</span> Inject Schedule
            </button>
            </div>
          </form>
        </div>

        <!-- Results Section for Inject Schedule -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Adding schedule...</p>
        </div>

        <div *ngIf="results && !loading" class="results-section fade-in">
          <div class="results-header">
            <h2>Schedule Injection Results</h2>
          </div>

          <div class="results-summary">
            <div class="summary-card no-conflict">
              <div class="summary-icon">
                <span>‚úÖ</span>
              </div>
              <div class="summary-details">
                <h3>Schedule Added Successfully</h3>
                <p>Schedule ID: <strong>{{results.schedule_id}}</strong></p>
                <p>Room: <strong>{{results.room_id}}</strong></p>
                <p>Day: <strong>{{results.day}}</strong></p>
                <p>Time: <strong>{{results.time_range}}</strong></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        
        <!-- Enhanced Reallocate Tab -->
    <div *ngIf="activeTab === 'Reallocate'" class="tab-content">
      <div class="tab-pane fade-in">
        
        <!-- Step 1: Search and Select Existing Schedule -->
        <div class="reallocate-step">
          <h3 class="step-title">
            <span class="step-number">1</span>
            Find Schedule to Move
          </h3>
          
          <div class="schedule-search-section">
            <form [formGroup]="scheduleSearchForm" class="search-form">
              <div class="search-controls">
                <div class="search-row">
                  <div class="search-group">
                    <label class="search-label">Search Query</label>
                    <input class="search-input" 
                           formControlName="searchQuery" 
                           placeholder="Search by Room ID, Course, or Lecturer"
                           (input)="searchExistingSchedules()">
              </div>
              
                  <div class="search-group">
                    <label class="search-label">Room ID</label>
                    <input class="search-input" 
                           formControlName="roomId" 
                           placeholder="Filter by Room ID"
                           (input)="searchExistingSchedules()">
              </div>
            </div>
            
                <div class="search-row">
                  <div class="search-group">
                    <label class="search-label">Day</label>
                    <select class="search-select" 
                            formControlName="day" 
                            (change)="searchExistingSchedules()">
                      <option value="">All Days</option>
                      <option *ngFor="let day of dayOptions" [value]="day">{{day}}</option>
                    </select>
                  </div>
                  
                  <div class="search-group">
                    <label class="search-label">Course</label>
                    <input class="search-input" 
                           formControlName="course" 
                           placeholder="Filter by Course"
                           (input)="searchExistingSchedules()">
                  </div>
                </div>
              </div>
            </form>
            
            <!-- Loading State -->
            <div *ngIf="scheduleSearchLoading" class="search-loading">
              <div class="loading-spinner-small"></div>
              <p>Searching schedules...</p>
            </div>
            
            <!-- Search Results -->
            <div *ngIf="foundSchedules.length > 0" class="schedule-results">
              <h4>Found Schedules ({{foundSchedules.length}})</h4>
              <div class="schedule-grid">
                <div *ngFor="let schedule of foundSchedules" 
                     class="schedule-card"
                     [class.selected]="selectedSchedule?.id === schedule.id"
                     (click)="selectScheduleForReallocation(schedule)">
                  <div class="schedule-header">
                    <h5 class="schedule-course">{{schedule.course}}</h5>
                    <span class="schedule-room">{{schedule.room_id}}</span>
                  </div>
                  <div class="schedule-details">
                    <p><span class="detail-label">Day:</span> {{schedule.day}}</p>
                    <p><span class="detail-label">Time:</span> {{schedule.start}} - {{schedule.end}}</p>
                    <p><span class="detail-label">Lecturer:</span> {{schedule.lecturer}}</p>
                    <p><span class="detail-label">Department:</span> {{schedule.department}}</p>
                  </div>
                  <div class="schedule-actions">
                    <button class="select-button" 
                            [class.selected]="selectedSchedule?.id === schedule.id">
                      {{selectedSchedule?.id === schedule.id ? 'Selected' : 'Select'}}
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- No Results -->
            <div *ngIf="foundSchedules.length === 0 && !scheduleSearchLoading && (scheduleSearchForm.get('searchQuery')?.value || scheduleSearchForm.get('roomId')?.value || scheduleSearchForm.get('day')?.value || scheduleSearchForm.get('course')?.value)" 
                 class="no-schedules-found">
              <div class="no-results-icon">üîç</div>
              <h4>No schedules found</h4>
              <p>Try adjusting your search criteria or check if the schedule exists.</p>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Set New Schedule Details -->
        <div class="reallocate-step" [class.disabled]="!selectedSchedule">
          <h3 class="step-title">
            <span class="step-number">2</span>
            Set New Schedule Details
            <span *ngIf="selectedSchedule" class="selected-indicator">
              Moving: {{selectedSchedule.course}} from {{selectedSchedule.room_id}}
            </span>
          </h3>
          
          <div class="new-schedule-section" *ngIf="selectedSchedule">
            
            <!-- Partial Update Info -->
            <div class="update-info-banner">
              <div class="info-icon">üí°</div>
              <div class="info-content">
                <h4>Partial Update Supported</h4>
                <p>You can update individual fields while keeping others unchanged. Only fill in the fields you want to modify!</p>
              </div>
            </div>
            
            <form [formGroup]="form" class="modern-form">
              <!-- Current vs New Comparison -->
              <div class="comparison-section">
                <div class="current-schedule">
                  <h4>Current Schedule</h4>
                  <div class="schedule-info">
                    <p><strong>Room:</strong> {{selectedSchedule.room_id}}</p>
                    <p><strong>Day:</strong> {{selectedSchedule.day}}</p>
                    <p><strong>Time:</strong> {{selectedSchedule.start}} - {{selectedSchedule.end}}</p>
                    <p><strong>Course:</strong> {{selectedSchedule.course}}</p>
                  </div>
                </div>
                <div class="arrow-indicator">‚Üí</div>
                <div class="new-schedule">
                  <h4>New Schedule</h4>
                  <div class="schedule-info">
                    <p><strong>Room:</strong> {{form.get('roomId')?.value || 'Not set'}}</p>
                    <p><strong>Day:</strong> {{form.get('day')?.value || 'Not set'}}</p>
                    <p><strong>Time:</strong> {{form.get('startTime')?.value || 'Not set'}} - {{form.get('endTime')?.value || 'Not set'}}</p>
                    <p><strong>Course:</strong> {{form.get('course')?.value || selectedSchedule.course}}</p>
                  </div>
                </div>
              </div>
              
              <!-- New Schedule Form -->
            <div class="form-row">
                <div class="form-group animate-on-hover">
                  <label class="form-label">New Room ID (Optional)</label>
                  <input class="form-input" 
                         formControlName="roomId" 
                         placeholder="Leave blank to keep current room: {{selectedSchedule.room_id}}">
                  <div class="form-hint">‚ú® Leave blank to keep current room, or enter new room ID to move</div>
                </div>
                
              <div class="form-group highlighted-field animate-on-hover">
                  <label class="form-label">Day (Optional)</label>
                  <select class="form-select" formControlName="day">
                    <option value="">Keep current day: {{selectedSchedule.day}}</option>
                  <option *ngFor="let day of dayOptions" [value]="day">{{day}}</option>
                </select>
                  <div class="form-hint">‚ú® Leave as current day or select new day</div>
                </div>
              </div>
              
              <div class="form-row">
              <div class="form-group animate-on-hover">
                <label class="form-label">Date (Optional)</label>
                <input class="form-input" type="date" formControlName="date">
                  <div class="form-hint">Used as fallback if day-based fails</div>
              </div>
            </div>
      
            <div class="form-row time-row">
              <div class="form-group animate-on-hover">
                  <label class="form-label">Start Time (Optional)</label>
                  <select class="form-select" formControlName="startTime">
                    <option value="">Keep current time: {{selectedSchedule.start}}</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
                  <div class="form-hint">‚ú® Leave blank to keep current start time</div>
              </div>
              
              <div class="form-group animate-on-hover">
                  <label class="form-label">End Time (Optional)</label>
                  <select class="form-select" formControlName="endTime">
                    <option value="">Keep current time: {{selectedSchedule.end}}</option>
                  <option *ngFor="let time of timeOptions" [value]="time">{{time}}</option>
                </select>
                  <div class="form-hint">‚ú® Leave blank to keep current end time</div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group animate-on-hover">
                  <label class="form-label">Course (Optional)</label>
                  <input class="form-input" 
                         formControlName="course" 
                         placeholder="Leave blank to keep current: {{selectedSchedule.course}}">
                  <div class="form-hint">Only change if course name is different</div>
              </div>
              
              <div class="form-group animate-on-hover">
                  <label class="form-label">Department (Optional)</label>
                  <input class="form-input" 
                         formControlName="department" 
                         placeholder="Leave blank to keep current: {{selectedSchedule.department}}">
                </div>
              </div>
              
              <div class="form-row">
              <div class="form-group animate-on-hover">
                  <label class="form-label">Lecturer (Optional)</label>
                  <input class="form-input" 
                         formControlName="lecturer" 
                         placeholder="Leave blank to keep current: {{selectedSchedule.lecturer}}">
              </div>
              
              <div class="form-group animate-on-hover">
                  <label class="form-label">Year (Optional)</label>
                  <input class="form-input" 
                         formControlName="level" 
                         placeholder="Enter year if needed">
              </div>
            </div>
          
            <div class="form-actions">
                <button class="action-button secondary" 
                        (click)="selectedSchedule = null; form.reset()">
                  <span class="button-icon">‚Ü©Ô∏è</span> Back to Search
                </button>
                <button class="action-button primary pulse-animation" 
                        (click)="executeOperation('reallocate')" 
                        [disabled]="loading">
                  <span class="button-icon">üîÑ</span> Update Schedule
            </button>
            </div>
          </form>
      </div>
      
          <div class="no-schedule-selected" *ngIf="!selectedSchedule">
            <div class="placeholder-content">
              <div class="placeholder-icon">üìã</div>
              <h4>No Schedule Selected</h4>
              <p>Please select a schedule from Step 1 to configure the new details.</p>
            </div>
          </div>
        </div>
        
        <!-- Loading State -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Processing reallocation...</p>
        </div>

        <!-- Results Section -->
        <div *ngIf="results && !loading" class="results-section fade-in">
          <div class="results-header">
            <h2>Reallocation Results</h2>
          </div>
          
          <div class="results-summary">
            <div class="summary-card no-conflict">
              <div class="summary-icon">
                <span>‚úÖ</span>
              </div>
              <div class="summary-details">
                <h3>Schedule Reallocated Successfully</h3>
                <div class="reallocation-details">
                  <div class="before-after">
                    <div class="before">
                      <h4>Before</h4>
                      <p><strong>Room:</strong> {{results.original_schedule?.room_id}}</p>
                      <p><strong>Time:</strong> {{results.original_schedule?.time}}</p>
                      <p><strong>Day:</strong> {{results.original_schedule?.day}}</p>
                    </div>
                    <div class="arrow">‚Üí</div>
                    <div class="after">
                      <h4>After</h4>
                      <p><strong>Room:</strong> {{results.new_schedule?.room_id}}</p>
                      <p><strong>Time:</strong> {{results.new_schedule?.start_time}} - {{results.new_schedule?.end_time}}</p>
                      <p><strong>Day:</strong> {{results.new_schedule?.day}}</p>
                    </div>
                  </div>
                </div>
              </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Room Selection Popup Modal -->
<div *ngIf="showRoomSelectionModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h2>Inject Schedule for Room {{selectedRoom?.room_id}}</h2>
      <button class="close-button" (click)="closeRoomSelectionModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="injectScheduleForm" class="modern-form">
        <div class="form-row">
          <div class="form-group animate-on-hover">
            <label class="form-label">Room ID</label>
            <input class="form-input" formControlName="roomId" readonly>
          </div>
          
          <div class="form-group highlighted-field animate-on-hover">
            <label class="form-label">Day</label>
            <input class="form-input" formControlName="day" readonly>
          </div>
        </div>

        <div class="form-row time-row">
          <div class="form-group animate-on-hover">
            <label class="form-label">Start Time</label>
            <select class="form-select" formControlName="startTime" required (change)="updateEndTimeOptions()">
              <option value="" disabled selected>Select time</option>
              <option *ngFor="let slot of availableTimeSlots" [value]="slot.start">{{slot.start}}</option>
            </select>
          </div>
          
          <div class="form-group animate-on-hover">
            <label class="form-label">End Time</label>
            <select class="form-select" formControlName="endTime" required>
              <option value="" disabled selected>Select time</option>
              <option *ngFor="let time of endTimeOptions" [value]="time">{{time}}</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group animate-on-hover">
            <label class="form-label">Course</label>
            <input class="form-input" formControlName="course" placeholder="Enter course name" required>
          </div>
          
          <div class="form-group animate-on-hover">
            <label class="form-label">Department</label>
            <input class="form-input" formControlName="department" placeholder="Enter department" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group animate-on-hover">
            <label class="form-label">Year</label>
            <input class="form-input" formControlName="level" placeholder="Enter year" required>
          </div>
          
          <div class="form-group animate-on-hover">
            <label class="form-label">Lecturer (Optional)</label>
            <input class="form-input" formControlName="lecturer" placeholder="Enter lecturer name">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="action-button secondary" (click)="closeRoomSelectionModal()">Cancel</button>
      <button class="action-button primary pulse-animation" 
              [disabled]="injectScheduleForm.invalid || injectLoading" 
              (click)="injectScheduleForSelectedRoom()">
        <span *ngIf="!injectLoading">Inject Schedule</span>
        <span *ngIf="injectLoading" class="spinner-small"></span>
      </button>
    </div>
  </div>
</div>

<!-- Multiple Schedules Selection Modal -->
<div *ngIf="showMultipleSchedulesModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h2>Multiple Schedules Found</h2>
      <button class="close-button" (click)="showMultipleSchedulesModal = false">√ó</button>
    </div>
    <div class="modal-body">
      <p class="modal-description">
        Multiple schedules match your criteria. Please select the specific schedule you want to reallocate:
      </p>
      
      <div class="multiple-schedules-list">
        <div *ngFor="let schedule of multipleScheduleOptions" 
             class="schedule-option"
             (click)="selectSpecificSchedule(schedule)">
          <div class="schedule-option-header">
            <h4>{{schedule.course}}</h4>
            <span class="schedule-option-room">{{schedule.room_id}}</span>
          </div>
          <div class="schedule-option-details">
            <p><strong>Day:</strong> {{schedule.day}}</p>
            <p><strong>Time:</strong> {{schedule.time}}</p>
            <p><strong>Lecturer:</strong> {{schedule.lecturer}}</p>
          </div>
          <button class="select-option-button">Select This Schedule</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-button secondary" (click)="showMultipleSchedulesModal = false">Cancel</button>
    </div>
  </div>
</div>

<!-- Enhanced Overlap Analysis Results -->
<div *ngIf="results && results.overlap_analysis" class="overlap-analysis-section">
  <h3>üìä Comprehensive Overlap Analysis</h3>
  
  <!-- Analysis Summary Card -->
  <div class="analysis-summary-card">
    <h4>{{results.room_id}} - {{results.day}}</h4>
    <div class="summary-stats">
      <div class="stat-item">
        <span class="stat-number">{{results.schedule_summary?.total_schedules || 0}}</span>
        <span class="stat-label">Total Schedules</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" [style.color]="results.overlap_analysis?.has_overlaps ? '#dc3545' : '#28a745'">
          {{results.overlap_analysis?.total_conflicts || 0}}
        </span>
        <span class="stat-label">Conflicts</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" [style.color]="results.utilization_analysis?.status_color">
          {{results.utilization_analysis?.utilization_percentage || 0}}%
        </span>
        <span class="stat-label">Utilization</span>
      </div>
    </div>
  </div>
  
  <!-- Conflict Details (if any) -->
  <div *ngIf="results.overlap_analysis?.has_overlaps" class="conflicts-section">
    <h4>üö® Schedule Conflicts ({{results.overlap_analysis.total_conflicts}})</h4>
    <div class="conflict-list">
      <div *ngFor="let conflict of results.overlap_analysis.overlapping_pairs" class="conflict-item">
        <div class="conflict-header">
          <span class="severity-badge" [style.background-color]="conflict.severity_color">
            {{conflict.severity_icon}} {{conflict.conflict_severity}}
          </span>
          <span class="overlap-time">{{conflict.overlap_period}} ({{conflict.overlap_duration}})</span>
        </div>
        <div class="conflicting-schedules">
          <div class="schedule-detail">
            <strong>{{conflict.schedule1.course}}</strong>
            <span class="time-range">{{conflict.schedule1.time}}</span>
            <span class="department">{{conflict.schedule1.department}}</span>
          </div>
          <div class="vs-divider">VS</div>
          <div class="schedule-detail">
            <strong>{{conflict.schedule2.course}}</strong>
            <span class="time-range">{{conflict.schedule2.time}}</span>
            <span class="department">{{conflict.schedule2.department}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- No Conflicts Message -->
  <div *ngIf="!results.overlap_analysis?.has_overlaps" class="no-conflicts">
    <div class="success-message">
      <span class="success-icon">‚úÖ</span>
      <h4>No Schedule Conflicts Found</h4>
      <p>All schedules for {{results.room_id}} on {{results.day}} are properly separated.</p>
    </div>
  </div>
  
  <!-- Utilization Analysis -->
  <div class="utilization-section">
    <h4>üìà Room Utilization Analysis</h4>
    <div class="utilization-details">
      <div class="utilization-bar">
        <div class="utilization-fill" 
             [style.width.%]="results.utilization_analysis?.utilization_percentage || 0"
             [style.background-color]="results.utilization_analysis?.status_color">
        </div>
      </div>
      <div class="utilization-stats">
        <div class="util-stat">
          <label>Scheduled Time:</label>
          <span>{{results.utilization_analysis?.total_scheduled_time}}</span>
        </div>
        <div class="util-stat">
          <label>Business Hours:</label>
          <span>{{results.utilization_analysis?.business_hours}}</span>
        </div>
        <div class="util-stat">
          <label>Status:</label>
          <span [style.color]="results.utilization_analysis?.status_color">
            {{results.utilization_analysis?.status_icon}} {{results.utilization_analysis?.utilization_status}}
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Free Time Slots -->
  <div *ngIf="results.free_time_analysis?.total_free_slots > 0" class="free-time-section">
    <h4>‚è∞ Available Time Slots ({{results.free_time_analysis.total_free_slots}})</h4>
    <div class="free-slots-grid">
      <div *ngFor="let slot of results.free_time_analysis.free_slots" class="free-slot-item">
        <span class="slot-time">{{formatTimeRange(slot.start, slot.end)}}</span>
        <span class="slot-duration">{{slot.duration}}</span>
      </div>
    </div>
  </div>
  
  <!-- All Schedules List -->
  <div *ngIf="results.all_schedules?.length > 0" class="all-schedules-section">
    <h4>üìã All Schedules ({{results.all_schedules.length}})</h4>
    <div class="schedules-table">
      <div class="schedule-header">
        <span>Time</span>
        <span>Course</span>
        <span>Department</span>
        <span>Duration</span>
        <span>Conflicts</span>
      </div>
      <div *ngFor="let schedule of results.all_schedules" class="schedule-row">
        <span class="schedule-time">{{formatTimeRange(schedule.start, schedule.end)}}</span>
        <span class="schedule-course">{{schedule.course}}</span>
        <span class="schedule-department">{{schedule.department}}</span>
        <span class="schedule-duration">{{schedule.duration_formatted}}</span>
        <span class="schedule-conflicts" 
              [style.color]="getConflictCount(schedule.course) > 0 ? '#dc3545' : '#28a745'">
          {{getConflictCount(schedule.course) > 0 ? getConflictCount(schedule.course) + ' conflicts' : 'No conflicts'}}
        </span>
      </div>
    </div>
  </div>
  
  <!-- Specific Time Check Results (if applicable) -->
  <div *ngIf="results.specific_time_check" class="specific-time-section">
    <h4>üéØ Specific Time Slot Analysis</h4>
    <div class="time-check-result">
      <div class="requested-time">
        <strong>Requested Time:</strong> {{results.specific_time_check.requested_time}}
      </div>
      <div class="availability-status" 
           [style.color]="results.specific_time_check.is_available ? '#28a745' : '#dc3545'">
        <span class="status-icon">{{results.specific_time_check.is_available ? '‚úÖ' : '‚ùå'}}</span>
        {{results.specific_time_check.recommendation}}
      </div>
      <div *ngIf="results.specific_time_check.conflicts?.length > 0" class="time-conflicts">
        <h5>Conflicting Schedules:</h5>
        <div *ngFor="let conflict of results.specific_time_check.conflicts" class="time-conflict-item">
          <span class="conflict-course">{{conflict.course}}</span>
          <span class="conflict-time">{{conflict.time}}</span>
          <span class="conflict-dept">{{conflict.department}}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Recommendations -->
  <div *ngIf="results.recommendations?.length > 0" class="recommendations-section">
    <h4>üí° Optimization Recommendations</h4>
    <div class="recommendations-list">
      <div *ngFor="let recommendation of results.recommendations" class="recommendation-item">
        {{recommendation}}
      </div>
    </div>
  </div>
  
  <!-- Data Quality Issues -->
  <div *ngIf="results.data_quality?.total_invalid > 0" class="data-quality-section">
    <h4>‚ö†Ô∏è Data Quality Issues ({{results.data_quality.total_invalid}})</h4>
    <div class="invalid-schedules">
      <div *ngFor="let invalid of results.data_quality.invalid_schedules" class="invalid-item">
        <span class="issue-type">{{invalid.issue}}</span>
        <span class="invalid-course">{{invalid.course}}</span>
        <span class="invalid-time">{{invalid.start}} - {{invalid.end}}</span>
      </div>
    </div>
  </div>
</div>

